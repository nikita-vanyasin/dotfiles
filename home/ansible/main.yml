---
- name: My Thinkpad X1 gen7 laptop provisioning
  hosts: localhost
  become: yes
  vars:
    local_home: "{{ lookup('env','HOME') }}"
    local_user: "{{ lookup('env','USER') }}"
  tasks:
    - name: create and setup aur_builder user
      user: name=aur_builder
    - name: grant aur_builder more permissions
      lineinfile:
        path: /etc/sudoers.d/aur_builder-allow-to-sudo-pacman
        state: present
        line: "aur_builder ALL=(ALL) NOPASSWD: /usr/bin/pacman"
        validate: /usr/bin/visudo -cf %s
        create: yes
    - name: create projects dir
      file:
        path: "{{ local_home }}/projects"
        state: directory
        mode: '0755'
    - name: packages
      pacman:
        update_cache: yes
        name:
          - mc
          - xf86-video-intel
          - xorg
          - xorg-xinit
          - i3
          - xf86-input-libinput
          - py3status
          - dmenu
          - pango
          - ttf-dejavu
          - zenity
          - thunderbird
          - xdg-utils
          - perl-file-mimeinfo
          - rxvt-unicode
          - dunst
          - go
          - htop
          - tor
          - fwupd
          - wget
          - pulseaudio
          - blueman
          - pulseaudio-bluetooth
          - ntfs-3g
          - udiskie
          - docker
          - remmina
          - freerdp
    - name: AUR packages
      aur:
        name:
          - xinit-xsession
          - j4-dmenu-desktop-git
          - pulseaudio-ctl
          - flameshot-git
          - telegram-desktop-bin
          - jetbrains-toolbox
          - safeeyes
          - google-chrome
        skip_installed: yes
      become: yes
      become_user: aur_builder
    - name: generate Xorg fonts index 100dpi
      command: mkfontdir /usr/share/fonts/100dpi
    - name: Configure display size (automatically detected size is incorrect)
      blockinfile:
        path: "/etc/X11/xorg.conf.d/90-monitor.conf"
        create: yes
        content: |
          Section "Monitor"
            Identifier    "<default monitor>"
            DisplaySize   310 174
          EndSection
    - name: Configure Keyboard layout and toggling
      blockinfile:
        path: "/etc/X11/xorg.conf.d/00-keyboard.conf"
        create: yes
        content: |
          Section "InputClass"
            Identifier "system-keyboard"
            MatchIsKeyboard "on"
            Option "XkbLayout" "us,ru"
            Option "XkbOptions" "grp:caps_toggle,grp_led:caps"
          EndSection
    - name: Configure Volume control buttons
      blockinfile:
        path: "/usr/share/pulseaudio/alsa-mixer/paths/analog-output.conf.common"
        marker: "; {mark} ANSIBLE MANAGED BLOCK"
        insertbefore: \[Element PCM\]
        content: |
          [Element Master]
          switch = mute
          volume = ignore
    - name: Congfigure Backlight control
      blockinfile:
        path: "/etc/X11/xorg.conf.d/10-intel_backlight.conf"
        create: yes
        content: |
          Section "Device"
            Identifier  "card0"
            Driver      "intel"
            Option      "Backlight"  "intel_backlight"
            BusID "PCI:0:2:0"
          EndSection
    - name: Lock screen automatically on Wake from sleep (suspend)
      blockinfile:
        path: /etc/systemd/system/wakelock.service
        create: yes
        content: |
          [Unit]
          Description=Runs i3lock on system resume from a suspended state
          Before=systemd-suspend.service
          
          [Service]
          User={{ local_user }}
          Type=forking
          Environment=DISPLAY=:0
          ExecStart=/usr/bin/i3lock -c '#000000'
          
          [Install]
          WantedBy=sleep.target
          WantedBy=suspend.target          
    - name: Enable wakelock service
      systemd:
        enabled: yes
        name: wakelock
    - name: Handly symlink for mounted devices
      file:
        state: link
        owner: "{{ local_user }}"
        dest: "/home/{{ local_user }}/media"
        src: "/run/media/{{ local_user }}"
    - name: Enable and start docker service
      systemd:
        enabled: yes
        state: started
        name: docker
        
